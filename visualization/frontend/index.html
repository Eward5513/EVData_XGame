<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, minimum-scale=1, user-scalable=no">
    <title>Geographic Data Visualization Platform</title>
    
    <!-- Cesium CSS -->
    <link href="Cesium-1.127/Build/Cesium/Widgets/widgets.css" rel="stylesheet">
    
    <!-- Custom CSS (modularized) -->
    <link href="css/base.css" rel="stylesheet">
    <link href="css/layout.css" rel="stylesheet">
    <link href="css/components.css" rel="stylesheet">
    <link href="css/status.css" rel="stylesheet">
    <link href="css/legend.css" rel="stylesheet">
    <link href="css/point-info.css" rel="stylesheet">
    <link href="css/cesium.css" rel="stylesheet">
    <link href="css/timeline.css" rel="stylesheet">
    <link href="css/timeline-modal.css" rel="stylesheet">
    <link href="css/speed-modal.css" rel="stylesheet">
</head>
<body>
    <div id="cesiumContainer" class="fullSize"></div>
    
    <!-- Speed Legend -->
    <div class="legend">
        <div class="legend-title">Speed Legend</div>
        <div class="legend-item">
            <div class="legend-color" style="background-color: green;"></div>
            <div class="legend-text">0-10 km/h</div>
        </div>
        <div class="legend-item">
            <div class="legend-color" style="background-color: yellow;"></div>
            <div class="legend-text">10-30 km/h</div>
        </div>
        <div class="legend-item">
            <div class="legend-color" style="background-color: orange;"></div>
            <div class="legend-text">30-50 km/h</div>
        </div>
        <div class="legend-item">
            <div class="legend-color" style="background-color: red;"></div>
            <div class="legend-text">50+ km/h</div>
        </div>
    </div>

    <!-- Control Panels Container -->
    <div class="panels-container">
        <!-- Vehicle Trajectory Panel -->
        <div id="vehiclePanel" class="control-panel">
            <div class="panel-header" data-panel="vehiclePanel">
                <h3>Vehicle Trajectory Visualization</h3>
                <div class="collapse-indicator">−</div>
            </div>
            <div class="panel-content">
            
            <div class="panel-section">
                <label for="vehicleMode">Vehicle Selection:</label>
                <select id="vehicleMode">
                    <option value="single" selected>Single Vehicle</option>
                    <option value="batch">First N Vehicles</option>
                    <option value="time_range">Time Range (All Vehicles)</option>
                </select>
            </div>
            
            <div class="panel-section" id="singleVehicleSection">
                <label for="vehicleId">Vehicle ID:</label>
                <input type="number" id="vehicleId" value="1" min="1" max="9999" style="width: 80px;">
            </div>
            
            <div class="panel-section" id="batchVehicleSection" style="display: none;">
                <label for="vehicleCount">First N Vehicles:</label>
                <input type="number" id="vehicleCount" value="3" min="1" max="50" style="width: 80px;">
                
                <div id="batchDirectionSection" class="filter-option direction-filter-container" style="margin-top: 10px;">
                    <div style="margin-bottom: 6px;">Direction Filter:</div>
                    <div id="batchDirection" class="direction-multi" style="display: flex; gap: 8px; flex-wrap: wrap;">
                        <label><input type="checkbox" name="batchDirection" value="A1-1"> A1-1 (East Straight)</label>
                        <label><input type="checkbox" name="batchDirection" value="A1-2"> A1-2 (West Straight)</label>
                        <label><input type="checkbox" name="batchDirection" value="B1-1"> B1-1 (North Straight)</label>
                        <label><input type="checkbox" name="batchDirection" value="B1-2"> B1-2 (South Straight)</label>
                        <label><input type="checkbox" name="batchDirection" value="A2-1"> A2-1 (Left to East)</label>
                        <label><input type="checkbox" name="batchDirection" value="A2-2"> A2-2 (Left to West)</label>
                        <label><input type="checkbox" name="batchDirection" value="B2-1"> B2-1 (Left to North)</label>
                        <label><input type="checkbox" name="batchDirection" value="B2-2"> B2-2 (Left to South)</label>
                        <label><input type="checkbox" name="batchDirection" value="A3-1"> A3-1 (Right to East)</label>
                        <label><input type="checkbox" name="batchDirection" value="A3-2"> A3-2 (Right to West)</label>
                        <label><input type="checkbox" name="batchDirection" value="B3-1"> B3-1 (Right to North)</label>
                        <label><input type="checkbox" name="batchDirection" value="B3-2"> B3-2 (Right to South)</label>
                        <label><input type="checkbox" name="batchDirection" value="C"> C (Other/Uncertain)</label>
                        <label><input type="checkbox" name="batchDirection" value="U"> U (U-turn)</label>
                    </div>
                </div>

                
            </div>
            
            <div class="panel-section" id="timeRangeVehicleSection" style="display: none;">
                <label for="vehicleStartTime">Start Time:</label>
                <input type="time" id="vehicleStartTime" style="width: 100px;">
                <label for="vehicleEndTime">End Time:</label>
                <input type="time" id="vehicleEndTime" style="width: 100px;">
                <button id="loadVehicleTimeRangeBtn" class="btn btn-small">Load Time Range</button>
                
                <div id="timeRangeDirectionSection" class="filter-option direction-filter-container" style="margin-top: 10px;">
                    <div style="margin-bottom: 6px;">Direction Filter:</div>
                    <div id="timeRangeDirection" class="direction-multi" style="display: flex; gap: 8px; flex-wrap: wrap;">
                        <label><input type="checkbox" name="timeRangeDirection" value="A1-1"> A1-1 (East Straight)</label>
                        <label><input type="checkbox" name="timeRangeDirection" value="A1-2"> A1-2 (West Straight)</label>
                        <label><input type="checkbox" name="timeRangeDirection" value="B1-1"> B1-1 (North Straight)</label>
                        <label><input type="checkbox" name="timeRangeDirection" value="B1-2"> B1-2 (South Straight)</label>
                        <label><input type="checkbox" name="timeRangeDirection" value="A2-1"> A2-1 (Left to East)</label>
                        <label><input type="checkbox" name="timeRangeDirection" value="A2-2"> A2-2 (Left to West)</label>
                        <label><input type="checkbox" name="timeRangeDirection" value="B2-1"> B2-1 (Left to North)</label>
                        <label><input type="checkbox" name="timeRangeDirection" value="B2-2"> B2-2 (Left to South)</label>
                        <label><input type="checkbox" name="timeRangeDirection" value="A3-1"> A3-1 (Right to East)</label>
                        <label><input type="checkbox" name="timeRangeDirection" value="A3-2"> A3-2 (Right to West)</label>
                        <label><input type="checkbox" name="timeRangeDirection" value="B3-1"> B3-1 (Right to North)</label>
                        <label><input type="checkbox" name="timeRangeDirection" value="B3-2"> B3-2 (Right to South)</label>
                        <label><input type="checkbox" name="timeRangeDirection" value="C"> C (Other/Uncertain)</label>
                        <label><input type="checkbox" name="timeRangeDirection" value="U"> U (U-turn)</label>
                    </div>
                </div>

                
                
                <div id="vehicleTimeRangeInfo" class="time-range-info" style="margin-top: 5px; font-size: 12px; color: #666;">
                    Click "Load Time Range" to see available time range for selected date
                </div>
            </div>
            
            <div class="panel-section">
                <label for="roadId">Road Intersection:</label>
                <select id="roadId">
                    <option value="A0003" selected>A0003</option>
                    <option value="A0008">A0008</option>
                </select>
            </div>
            
            <div class="panel-section">
                <label for="dateFilter">Date Filter:</label>
                <select id="dateFilter">
                    <option value="" selected>All Dates</option>
                </select>
                
            </div>

            
            
            <div class="panel-section">
                <label for="dataSource">Data Source:</label>
                <select id="dataSource">
                    <option value="merged" selected>Merged (after)</option>
                    <option value="split">Original (before)</option>
                    <option value="refined">Refined (skeleton)</option>
                </select>
            </div>
            
            <div class="panel-section">
                <label><input type="checkbox" id="pointsOnly"> Points only (no trajectory lines)</label>
            </div>
            
            <div class="panel-section">
                <button id="loadDataBtn" class="btn btn-primary">Load Data</button>
                <button id="clearDataBtn" class="btn btn-secondary">Clear Data</button>
            </div>
            
            <div class="panel-section">
                <div id="dataInfo" class="data-info">
                    <div id="totalPoints">Total Points: --</div>
                    <div id="timeRange">Time Range: --</div>
                    <div id="speedRange">Speed Range: --</div>
                </div>
            </div>
            
            <div class="panel-section">
                <div id="status" class="status">
                    <span id="statusText">Ready</span>
                    <div id="loadingSpinner" class="loading-spinner" style="display: none;"></div>
                </div>
            </div>
            </div>
        </div>

        <!-- Raw CSV Trajectory Panel -->
        <div id="rawPanel" class="control-panel">
            <div class="panel-header" data-panel="rawPanel">
                <h3>Raw CSV Trajectory</h3>
                <div class="collapse-indicator">−</div>
            </div>
            <div class="panel-content">

            <div class="panel-section">
                <label for="rawRoadId">Road Intersection:</label>
                <select id="rawRoadId">
                    <option value="A0003" selected>A0003</option>
                    <option value="A0008">A0008</option>
                </select>
            </div>

            <div class="panel-section">
                <label for="rawDate">Date:</label>
                <select id="rawDate">
                    <option value="" selected>Select Date</option>
                </select>
            </div>

            <div class="panel-section">
                <label for="rawVehicleId">Vehicle ID:</label>
                <input type="number" id="rawVehicleId" placeholder="Optional" min="1" style="width: 120px;">
            </div>

            <div class="panel-section">
                <button id="loadRawBtn" class="btn btn-primary">Load Raw</button>
                <button id="clearRawBtn" class="btn btn-secondary">Clear</button>
            </div>

            <div class="panel-section">
                <div id="rawStatus" class="status" style="display: none;">
                    <span id="rawStatusText"></span>
                </div>
            </div>
            </div>
        </div>

        <!-- Trajectories Preprocess Panel -->
        <div id="excludedPanel" class="control-panel">
            <div class="panel-header" data-panel="excludedPanel">
                <h3>Trajectories Preprocess</h3>
                <div class="collapse-indicator">−</div>
            </div>
            <div class="panel-content">

            <div class="panel-section">
                <label for="excludedRoadId">Road Intersection:</label>
                <select id="excludedRoadId">
                    <option value="A0003" selected>A0003</option>
                    <option value="A0008">A0008</option>
                </select>
            </div>

            <div class="panel-section">
                <label for="excludedDate">Date:</label>
                <select id="excludedDate">
                    <option value="" selected>Select Date</option>
                </select>
                
            </div>

            <div class="panel-section">
                <label for="excludedVehicleId">Vehicle ID:</label>
                <input type="number" id="excludedVehicleId" placeholder="Optional" min="1" style="width: 120px;">
            </div>

            <div class="panel-section">
                <button id="loadExcludedBtn" class="btn btn-primary">Load Excluded</button>
                <button id="clearExcludedBtn" class="btn btn-secondary">Clear</button>
            </div>

            <div class="panel-section">
                <div id="excludedStatus" class="status" style="display: none;">
                    <span id="excludedStatusText"></span>
                </div>
            </div>
            </div>
        </div>

        <!-- Traffic Light Timing Panel (A-direction crossover) -->
        <div id="crossoverPanel" class="control-panel">
            <div class="panel-header" data-panel="crossoverPanel">
                <h3>Traffic Light Timing</h3>
                <div class="collapse-indicator">−</div>
            </div>
            <div class="panel-content">
                <div class="panel-section">
                    <label for="crossoverRoadId">Road Intersection:</label>
                    <select id="crossoverRoadId">
                        <option value="A0003" selected>A0003</option>
                        <option value="A0008">A0008</option>
                    </select>
                </div>
                <div class="panel-section">
                    <div>Directions:</div>
                    <div id="crossoverDirection" class="direction-multi" style="display:flex; gap:8px; flex-wrap: wrap; margin-top:6px;">
                        <label><input type="checkbox" name="crossoverDirection" value="A1-1" checked> A1-1 (East Straight)</label>
                        <label><input type="checkbox" name="crossoverDirection" value="A1-2" checked> A1-2 (West Straight)</label>
                        <label><input type="checkbox" name="crossoverDirection" value="B1-1"> B1-1 (North Straight)</label>
                        <label><input type="checkbox" name="crossoverDirection" value="B1-2"> B1-2 (South Straight)</label>
                        <label><input type="checkbox" name="crossoverDirection" value="A2-1"> A2-1 (Left to East)</label>
                        <label><input type="checkbox" name="crossoverDirection" value="A2-2"> A2-2 (Left to West)</label>
                        <label><input type="checkbox" name="crossoverDirection" value="B2-1"> B2-1 (Left to North)</label>
                        <label><input type="checkbox" name="crossoverDirection" value="B2-2"> B2-2 (Left to South)</label>
                    </div>
                </div>
                <div class="panel-section">
                    <label for="crossoverDataset">Dataset:</label>
                    <select id="crossoverDataset">
                        <option value="standard" selected>Standard</option>
                        <option value="real">Real (A1)</option>
                    </select>
                </div>
                <div class="panel-section" style="display:flex; gap:8px; align-items:center;">
                    <button id="loadCrossoverBtn" class="btn btn-primary">Load Crossovers</button>
                    <button id="clearCrossoverBtn" class="btn btn-secondary">Clear</button>
                </div>
                <div class="panel-section">
                    <div id="crossoverStatus" class="status" style="display:none;">
                        <span id="crossoverStatusText"></span>
                    </div>
                </div>
                <div class="panel-section">
                    <div id="crossoverIntervals" class="traffic-light-status">
                        <div class="status-message">Click "Load Crossovers" to view intervals and render points.</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Speed Analysis Panel -->
        <div id="speedPanel" class="control-panel">
            <div class="panel-header" data-panel="speedPanel">
                <h3>Speed Analysis</h3>
                <div class="collapse-indicator">−</div>
            </div>
            <div class="panel-content">
            
            <div class="panel-section">
                <label for="speedMode">Analysis Mode:</label>
                <select id="speedMode">
                    <option value="single" selected>Single Vehicle</option>
                    <option value="time_range">Time Range (All Vehicles)</option>
                </select>
            </div>
            
            <div class="panel-section" id="singleSpeedSection">
                <label for="speedVehicleId">Vehicle ID:</label>
                <input type="number" id="speedVehicleId" value="1" min="1" max="9999" style="width: 80px;">
                
                <div style="margin-top: 10px;">
                    <label for="singleSpeedDirection">Direction Filter:</label>
                    <select id="singleSpeedDirection" style="width: 180px;">
                        <option value="" selected>All Directions</option>
                        <option value="A1-1">A1-1 (East Straight)</option>
                        <option value="A1-2">A1-2 (West Straight)</option>
                        <option value="B1-1">B1-1 (North Straight)</option>
                        <option value="B1-2">B1-2 (South Straight)</option>
                        <option value="A2-1">A2-1 (Left to East)</option>
                        <option value="A2-2">A2-2 (Left to West)</option>
                        <option value="B2-1">B2-1 (Left to North)</option>
                        <option value="B2-2">B2-2 (Left to South)</option>
                        <option value="A3-1">A3-1 (Right to East)</option>
                        <option value="A3-2">A3-2 (Right to West)</option>
                        <option value="B3-1">B3-1 (Right to North)</option>
                        <option value="B3-2">B3-2 (Right to South)</option>
                        <option value="C">C (Other/Uncertain)</option>
                        <option value="U">U (U-turn)</option>
                    </select>
                </div>
            </div>
            
            <div class="panel-section" id="timeRangeSpeedSection" style="display: none;">
                <label for="speedStartTime">Start Time:</label>
                <input type="time" id="speedStartTime" style="width: 100px;">
                <label for="speedEndTime">End Time:</label>
                <input type="time" id="speedEndTime" style="width: 100px;">
                <button id="loadTimeRangeBtn" class="btn btn-small">Load Time Range</button>
                
                <div style="margin-top: 10px;">
                    <label for="timeRangeSpeedDirection">Direction Filter:</label>
                    <select id="timeRangeSpeedDirection" style="width: 180px;">
                        <option value="" selected>All Directions</option>
                        <option value="A1-1">A1-1 (East Straight)</option>
                        <option value="A1-2">A1-2 (West Straight)</option>
                        <option value="B1-1">B1-1 (North Straight)</option>
                        <option value="B1-2">B1-2 (South Straight)</option>
                        <option value="A2-1">A2-1 (Left to East)</option>
                        <option value="A2-2">A2-2 (Left to West)</option>
                        <option value="B2-1">B2-1 (Left to North)</option>
                        <option value="B2-2">B2-2 (Left to South)</option>
                        <option value="A3-1">A3-1 (Right to East)</option>
                        <option value="A3-2">A3-2 (Right to West)</option>
                        <option value="B3-1">B3-1 (Right to North)</option>
                        <option value="B3-2">B3-2 (Right to South)</option>
                        <option value="C">C (Other/Uncertain)</option>
                        <option value="U">U (U-turn)</option>
                    </select>
                </div>
                
                <div id="timeRangeInfo" class="time-range-info" style="margin-top: 5px; font-size: 12px; color: #666;">
                    Click "Load Time Range" to see available time range for selected date
                </div>
            </div>
            
            <div class="panel-section">
                <label for="speedRoadId">Road Intersection:</label>
                <select id="speedRoadId">
                    <option value="A0003" selected>A0003</option>
                    <option value="A0008">A0008</option>
                </select>
            </div>
            
            <div class="panel-section">
                <label for="speedDate">Date:</label>
                <select id="speedDate">
                    <option value="" selected>Select Date</option>
                </select>
                
            </div>
            
            <div class="panel-section">
                <label for="speedSegId">Seg ID:</label>
                <input type="number" id="speedSegId" placeholder="Optional" style="width: 80px;">
                <label style="margin-left:10px;" for="speedMetric">Metric:</label>
                <select id="speedMetric" style="width: 180px;">
                    <option value="speed" selected>speed</option>
                    <option value="acceleratorpedal">acceleratorpedal</option>
                    <option value="brakestatus">brakestatus</option>
                    <option value="gearnum">gearnum</option>
                    <option value="havebrake">havebrake</option>
                    <option value="havedriver">havedriver</option>
                </select>
            </div>
            
            <div class="panel-section">
                <button id="analyzeSpeedBtn" class="btn btn-primary">Analyze Speed</button>
            </div>
            
            <div class="panel-section">
                <div id="speedAnalysisStatus" class="speed-analysis-status">
                    <div class="status-message">Select vehicle(s) and date, then click "Analyze Speed" to view the speed chart.</div>
                </div>
            </div>
            
            <div class="panel-section">
                <div id="speedStatus" class="status" style="display: none;">
                    <span id="speedStatusText"></span>
                </div>
            </div>
            </div>
        </div>

        <!-- Infer Road Panel -->
        <div id="inferRoadPanel" class="control-panel">
            <div class="panel-header" data-panel="inferRoadPanel">
                <h3>Infer Road Overlays</h3>
                <div class="collapse-indicator">−</div>
            </div>
            <div class="panel-content">
                <div class="panel-section">
                    <label for="inferRoadId">Road Intersection:</label>
                    <select id="inferRoadId">
                        <option value="A0003" selected>A0003</option>
                        <option value="A0008">A0008</option>
                    </select>
                </div>

                <div class="panel-section">
                    <label for="inferOrientation">Direction:</label>
                    <select id="inferOrientation">
                        <option value="NS" selected>南北向 (B)</option>
                        <option value="EW">东西向 (A)</option>
                    </select>
                </div>
                <div class="panel-section">
                    <button id="loadInferenceBtn" class="btn btn-primary">Infer Road</button>
                    <button id="clearInferenceBtn" class="btn btn-secondary">Clear Road</button>
                </div>

                <div class="panel-section">
                    <div class="status" id="inferenceStatus" style="display: none;">
                        <span id="inferenceStatusText"></span>
                    </div>
                </div>
            </div>
        </div>

        
    </div>

    <!-- Traffic Light Timeline Modal -->
    <div id="timelineModal" class="timeline-modal">
        <div class="timeline-modal-content">
            <div class="timeline-modal-header">
                <h3 id="timelineModalTitle">Traffic Light Timeline</h3>
                <button id="closeTimelineModal" class="close-btn">&times;</button>
            </div>
            <div class="timeline-modal-body">
                <div id="timelineModalData"></div>
            </div>
        </div>
    </div>

    <!-- Speed Analysis Modal -->
    <div id="speedModal" class="speed-modal">
        <div class="speed-modal-content">
            <div class="speed-modal-header">
                <h3 id="speedModalTitle">Speed Analysis Chart</h3>
                <button id="closeSpeedModal" class="close-btn">&times;</button>
            </div>
            <div class="speed-modal-body">
                <div id="speedChartContainer"></div>
            </div>
        </div>
    </div>

    <!-- Cesium JS -->
    <script src="Cesium-1.127/Build/Cesium/Cesium.js"></script>
    
    <!-- Custom JS -->
    <script type="module" src="js/app.js"></script>
</body>
</html>
